<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Face Test</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
    }
    #overlay {
      position: absolute;
      top: 0px;
      left: 0px;
    }
  </style>
</head>
<body>
  <script src="./js/utils.js"></script>
  <script src="./js/numeric-1.2.6.min.js"></script>
  <script src="./js/mosse.js"></script>
  <script src="./js/jsfeat-min.js"></script>
  <script src="./js/frontalface.js"></script>
  <script src="./js/jsfeat_detect.js"></script>
  <script src="./js/left_eye_filter.js"></script>
  <script src="./js/right_eye_filter.js"></script>
  <script src="./js/nose_filter.js"></script>
  <script src="./models/model_pca_20_svm.js"></script>
  <script src="./js/clm.js"></script>
  <script src="./js/svmfilter_webgl.js"></script>
  <script src="./js/svmfilter_fft.js"></script>
  <script src="./js/mossefilter.js"></script>
  <div id="container">
    <video id="videoel" width="400" height="300" preload="auto" loop>
      <!--<video id="videoel" width="320" height="240" preload="auto">-->
      <!--<source src="./media/franck.ogv" type="video/ogg"/>-->
    </video>
    <canvas id="overlay" width="400" height="300"></canvas>
  </div>
  <input class="btn" type="button" value="wait, loading video" disabled="disabled" onclick="startVideo()" id="startbutton"></input>
  <script type="text/javascript">
    var vid = document.getElementById('videoel');
    var overlay = document.getElementById('overlay');
    var overlayCC = overlay.getContext('2d');
    
    var ctrack = new clm.tracker({useWebGL : true});
    ctrack.init(pModel);
    function enablestart() {
      var startbutton = document.getElementById('startbutton');
      startbutton.value = "start";
      startbutton.disabled = null;
    }

    function startVideo() {
      // start video
      vid.play();
      // start tracking
      ctrack.start(vid);
      // start loop to draw face
      drawLoop();
    }

    function drawLoop() {
      requestAnimFrame(drawLoop);
      overlayCC.clearRect(0, 0, 400, 300);
      //psrElement.innerHTML = "score :" + ctrack.getScore().toFixed(4);
      var positions = ctrack.getCurrentPosition()
      if (positions) {
        ctrack.draw(overlay);
        var mustache = new Image()
        mustache.src = '/img/mustache.png'
        var noseMouthDiff = Math.abs(positions[47][1] - positions[37][1])
        var newWidth = Math.abs(positions[44][0] - positions[50][0])
        var newHeight = Math.abs(mustache.height * newWidth / mustache.width)
        overlayCC.drawImage(
          mustache,
          positions[44][0],
          positions[44][1] - (noseMouthDiff),
          newWidth,
          newHeight
        )
        // console.log(positions)
      }
    }

    navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;
    window.URL = window.URL || window.webkitURL || window.msURL || window.mozURL;

    // check for camerasupport
    if (navigator.getUserMedia) {
      // set up stream
      
      var videoSelector = {video : true};
      if (window.navigator.appVersion.match(/Chrome\/(.*?) /)) {
        var chromeVersion = parseInt(window.navigator.appVersion.match(/Chrome\/(\d+)\./)[1], 10);
        if (chromeVersion < 20) {
          videoSelector = "video";
        }
      };
    
      navigator.getUserMedia(videoSelector, function( stream ) {
        if (vid.mozCaptureStream) {
          vid.mozSrcObject = stream;
        } else {
          vid.src = (window.URL && window.URL.createObjectURL(stream)) || stream;
        }
        vid.play();
      }, function() {
        insertAltVideo(vid);
        document.getElementById('gum').className = "hide";
        document.getElementById('nogum').className = "nohide";
        alert("There was some problem trying to fetch video from your webcam, using a fallback video instead.");
      });
    } else {
      insertAltVideo(vid);
      document.getElementById('gum').className = "hide";
      document.getElementById('nogum').className = "nohide";
      alert("Your browser does not seem to support getUserMedia, using a fallback video instead.");
    }

    vid.addEventListener('canplay', enablestart, false);

  </script>
</body>
</html>